# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

- **Run tests:** `npm test` (runs 86 tests via custom runner in `tests/fee-engine.test.js`)
- **Build broker pages:** `node build-broker-pages.js` (generates `/broker/{slug}/index.html` pages and updates `sitemap.xml`)

There is no build step, bundler, linter, or framework. The site is static HTML + vanilla JS + CSS served as-is.

## Architecture

BrokerFinder is a static site helping UK investors compare investment platform fees. It has four tools, each a standalone HTML page loading shared JS modules via `<script>`:

- **Compare** (`/compare/`) — Multi-step wizard that ranks brokers by total annual cost. Core logic in `js/compare.js`.
- **Quick Check** (`/check/`) — 2-question tool showing current broker cost vs alternatives. Logic in `js/check.js`.
- **Calculator** (`/calculator/`) — Compound growth calculator showing fee impact over time. Logic in `js/calculator.js` with SVG chart rendering.
- **Broker Pages** (`/broker/{slug}/`) — Generated by `build-broker-pages.js` from `data/brokers.json`. Not hand-edited.

### Key modules

- **`js/fee-engine.js`** — Central fee calculation engine. Handles 4 fee types (fixed, percentage, tiered, thresholded). Key functions: `calculateCost()` (full cost for a broker), `calculatePerAccountPlatformFee()` (splits across ISA/SIPP/GIA with caps), `describePlatformFee()` (human-readable breakdowns). All other JS files depend on this.
- **`js/shared.js`** — Utilities: currency formatting, theme toggle, mobile nav, tax year banner.
- **`data/brokers.json`** — Single source of truth for all broker data (fees, accounts, ratings, etc.).
- **`css/style.css`** — All styling. Uses CSS custom properties for light/dark theming via `data-theme="dark"` attribute.

### Data flow

All fee computation is client-side. Pages fetch `data/brokers.json` at load, pass user inputs through the fee engine, and render results via DOM manipulation. No server, no API, no localStorage (except theme preference).

## Testing

Tests are in `tests/fee-engine.test.js` — a self-contained custom test runner (no test framework dependency). Tests load `fee-engine.js` via `eval()` and verify calculations against known values. To add tests, append to the `tests` array following the existing pattern of `{ name, fn }` objects.

## Working with broker data

Broker fee structures in `data/brokers.json` use a specific schema. The `platformFee` field can be: `{ type: "fixed", annual }`, `{ type: "percentage", rate, cap? }`, `{ type: "tiered", tiers[] }`, or `{ type: "thresholded", thresholds[] }`. When modifying fee logic, always run `npm test` and update tests for new edge cases. After changing broker data, run `node build-broker-pages.js` to regenerate broker detail pages.
